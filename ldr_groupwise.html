<html>

<body>
    <script>
        function isEmpty(obj) {
            return Object.keys(obj).length === 0;
        }

        function getClosingBlance(oldObj, newObj) {
            let _amo = 0;
            let _type = '';
            const _old_cl_bal = Number(oldObj.cl_balance);
            const _new_tr_amo = Number(newObj.tr_amount);
            if (oldObj.cl_type === newObj.tr_type) {
                _amo = _old_cl_bal + _new_tr_amo;
                _type = oldObj.cl_type;
            } else {
                _amo = Math.abs(_old_cl_bal - _new_tr_amo);
                _type = (_old_cl_bal > _new_tr_amo) ? oldObj.cl_type : newObj.tr_type;
            }
            let obj = {
                type: _type,
                amount: _amo
            }
            return obj;
        }

        let ldr_old_data = [{
            "ldr_ref_id": "49_STU_4",
            "grp_ref_code": "1003_4",
            "entry_month": "4",
            "op_balance": 0,
            "op_type": "CR",
            "tr_amount": 1198,
            "tr_type": "DR",
            "cl_balance": 1198,
            "cl_type": "DR",
        }, {
            "ldr_ref_id": "9_LDR_4",
            "grp_ref_code": "1002_4",
            "entry_month": "4",
            "op_balance": 0,
            "op_type": "CR",
            "tr_amount": 1090,
            "tr_type": "CR",
            "cl_balance": 1090,
            "cl_type": "CR",
        }, {
            "ldr_ref_id": "1_LDR_4",
            "grp_ref_code": "1002_4",
            "entry_month": "4",
            "op_balance": 0,
            "op_type": "CR",
            "tr_amount": 108,
            "tr_type": "CR",
            "cl_balance": 108,
            "cl_type": "CR",
        }];
        let ldr_data = [{
            "id": "5076",
            "ldr_ref_id": "49_STU_4",
            "grp_ref_code": "1003_4",
            "ledger_folio": "9_LDR_4",
            "entry_month": "4",
            "tr_amount": "545",
            "tr_type": "DR",
            "session_year_id": "1",
        }, {
            "id": "5077",
            "ldr_ref_id": "9_LDR_4",
            "grp_ref_code": "1002_4",
            "ledger_folio": "49_STU_4",
            "entry_month": "4",
            "tr_amount": "545",
            "tr_type": "CR",
            "session_year_id": "1",
        }, {
            "id": "5078",
            "ldr_ref_id": "49_STU_4",
            "grp_ref_code": "1003_4",
            "ledger_folio": "1_LDR_4",
            "entry_month": "4",
            "tr_amount": "54",
            "tr_type": "DR",
            "session_year_id": "1",
        }, {
            "id": "5079",
            "ldr_ref_id": "1_LDR_4",
            "grp_ref_code": "1002_4",
            "ledger_folio": "49_STU_4",
            "entry_month": "4",
            "tr_amount": "54",
            "tr_type": "CR",
            "session_year_id": "1",
        }, {
            "id": "5136",
            "ldr_ref_id": "49_STU_4",
            "grp_ref_code": "1003_4",
            "ledger_folio": "9_LDR_4",
            "entry_month": "5",
            "tr_amount": "545",
            "tr_type": "DR",
            "session_year_id": "1",
            "server_date_time": "2020-10-28 19:36:19"
        }, {
            "id": "5137",
            "ldr_ref_id": "9_LDR_4",
            "grp_ref_code": "1002_4",
            "ledger_folio": "49_STU_4",
            "entry_month": "5",
            "tr_amount": "545",
            "tr_type": "CR",
            "session_year_id": "1",
            "server_date_time": "2020-10-28 19:36:19"
        }, {
            "id": "5138",
            "ldr_ref_id": "49_STU_4",
            "grp_ref_code": "1003_4",
            "ledger_folio": "1_LDR_4",
            "entry_month": "5",
            "tr_amount": "54",
            "tr_type": "DR",
            "session_year_id": "1",
            "server_date_time": "2020-10-28 19:36:19"
        }, {
            "id": "5139",
            "ldr_ref_id": "1_LDR_4",
            "grp_ref_code": "1002_4",
            "ledger_folio": "49_STU_4",
            "entry_month": "5",
            "tr_amount": "54",
            "tr_type": "CR",
            "session_year_id": "1",
            "server_date_time": "2020-10-28 19:36:19"
        }];
        // console.log(ldr_data);
        let _ldr_ids = [];
        ldr_data.map((item) => {
            if (!_ldr_ids.includes(item.ldr_ref_id)) {
                _ldr_ids.push(item.ldr_ref_id);
            }
        });
        // console.log(_ldr_ids);
        let _grp_ldr_items = [];
        // debugger
        _ldr_ids.map((item) => {
            let _op_amo = 0;
            let _cl_amo = 0;
            let _tr_amo = 0;
            let _ctr_item = {};
            let flag = 0;
            ldr_data.map((l_item) => {
                if (item === l_item.ldr_ref_id) {
                    _op_amo += Number(l_item.op_balance);
                    _cl_amo += Number(l_item.cl_balance);
                    _tr_amo += Number(l_item.tr_amount);
                    if (flag === 0) {
                        _ctr_item = l_item;
                        flag++;
                    }
                }
            });
            _ctr_item = {
                // "school_id": _ctr_item.school_id,
                // "school_name": _ctr_item.school_name,
                // "sch_medium": _ctr_item.sch_medium,
                "ldr_ref_id": _ctr_item.ldr_ref_id,
                "grp_ref_code": _ctr_item.grp_ref_code,
                "entry_month": _ctr_item.entry_month,
                "op_balance": _op_amo,
                "tr_amount": _tr_amo,
                "tr_type": "CR",
                "cl_balance": _cl_amo,
                "cl_type": "",
            };
            _grp_ldr_items.push(_ctr_item);
        });
        // console.log(JSON.stringify(_grp_ldr_items));


        // debugger;
        const _new_ldr_data = ldr_data.map((item, index) => {
            if (index === 0) {
                const _id = item.ldr_ref_id;
                const _old_item = ldr_old_data.filter((o_item) => {
                    if (_id === o_item.ldr_ref_id) {
                        return o_item;
                    }
                });
                const _val = isEmpty(_old_item);
                if (!_val) {

                    let obj = getClosingBlance(_old_item[0], item);

                    item = {
                        ...item,
                        "op_balance": _old_item[0].op_balance,
                        "op_type": _old_item[0].op_type,
                        "cl_balance": obj.amount,
                        "cl_type": obj.type,
                    }
                    console.log(item);
                    debugger;
                }
            } else {

            }
            return item;
        });
        console.log(JSON.stringify(_new_ldr_data));
    </script>
</body>

</html>