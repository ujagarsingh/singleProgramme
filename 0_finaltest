<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
 
<script type="text/javascript">

var vchr1 = {"voucher_obj":{"child":[{"ldr_ref_id":"108_STU_4","tr_amount":"300","tr_type":"CR","ledger_name":"AMAN MEENA S/o HARI NARAYAN MEENA [366/Eigth]","adjustment":true,"cost_center":false,"ref_child":[{"id":1,"ref_type":"New Ref","ref_name":359,"ref_tr_amount":"20","ref_tr_type":"CR"},{"id":1,"ref_type":"New Ref","ref_name":359,"ref_tr_amount":"80","ref_tr_type":"CR"},{"id":1,"ref_type":"New Ref","ref_name":359,"ref_tr_amount":"200","ref_tr_type":"CR"}],"ldr_last_balance":135,"ldr_crnt_balance":-165,"ldr_last_balance_type":"DR","ldr_crnt_balance_type":"DR"},{"ldr_ref_id":"141_STU_4","tr_amount":"120","tr_type":"CR","ledger_name":"AMIT MEENA S/o RAM KISHOR MEENA [419/Eigth]","adjustment":true,"cost_center":false,"ldr_last_balance":135,"ldr_crnt_balance":15,"ldr_last_balance_type":"DR","ldr_crnt_balance_type":"DR","ref_child":[{"id":1,"ref_type":"New Ref","ref_name":359,"ref_tr_amount":120,"ref_tr_type":"CR"}]},{"ldr_ref_id":"3_LDR_4","tr_amount":420,"tr_type":"DR","ledger_name":"Cash","adjustment":false,"cost_center":true,"ldr_last_balance":0,"ldr_crnt_balance":0,"ldr_last_balance_type":"CR","ldr_crnt_balance_type":"CR","ref_child":[{"id":"","ref_type":"","ref_name":"","ref_tr_amount":"","ref_tr_type":""}]}],"cr_total_amo":420,"dr_total_amo":420},"vchr_date":"2021-02-16T01:31:27.045Z","vchr_type":"Receipt"};

var vchr2 = {"voucher_obj":{"child":[{"ldr_ref_id":"108_STU_4","tr_amount":"120","tr_type":"CR","ledger_name":"AMAN MEENA S/o HARI NARAYAN MEENA [366/Eigth]","adjustment":true,"cost_center":false,"ref_child":[{"id":1,"ref_type":"New Ref","ref_name":359,"ref_tr_amount":120,"ref_tr_type":"CR"}],"ldr_last_balance":135,"ldr_crnt_balance":15,"ldr_last_balance_type":"DR","ldr_crnt_balance_type":"DR"},{"ldr_ref_id":"","tr_amount":120,"tr_type":"","ledger_name":"","adjustment":"","cost_center":""}],"cr_total_amo":120,"dr_total_amo":120},"vchr_date":"2021-02-16T02:27:53.540Z","vchr_type":"Receipt"};

function objPositionHandler(obj){
	const _obj = obj.voucher_obj;
	let final_all_obj = [];
	let final_obj = [];
	let final_flag = true;
	
	function ldrwithchildHandler(elem){
		let fl_obj = [];
		const tr_amo = Number(elem.tr_amount);
		const tr_type = elem.tr_type;
		const bal_amo = Number(elem.tr_amount);
		const bal_type = elem.tr_type;
		fl_obj.push({tr_amo : 0, tr_type : "", bal_amo, bal_type});
		
		let rBal_amo = 0;
		let rBal_type = "";

		elem.ref_child.forEach((rElem, inx) => {
			const _rtramo = Number(rElem.ref_tr_amount);
			const _rtrtype = rElem.ref_tr_type;
			if(_rtrtype === fl_obj[inx].bal_type){
				rBal_amo = Math.abs(fl_obj[inx].bal_amo - _rtramo);
				rBal_type = (rBal_amo === 0) ? "" : _rtrtype;
			} else if(_rtrtype === "DR" && fl_obj[inx].bal_type === "DR"){
				rBal_amo = Math.abs(fl_obj[inx].bal_amo - _rtramo);
				rBal_type = _rtrtype;
			} else if(_rtrtype === "CR" && fl_obj[inx].bal_type === "DR"){
				rBal_amo = fl_obj[inx].bal_amo + _rtramo;
				rBal_type = (fl_obj[inx].bal_amo > _rtramo) ? fl_obj[inx].bal_type : _rtrtype;	
			} else if(_rtrtype === "DR" && fl_obj[inx].bal_type === "CR"){
				rBal_amo = fl_obj[inx].bal_amo + _rtramo;
				rBal_type = (fl_obj[inx].bal_amo > _rtramo) ? fl_obj[inx].bal_type : _rtrtype;	
			} 
			fl_obj.push({tr_amo : _rtramo, tr_type : _rtrtype, bal_amo : rBal_amo, bal_type : rBal_type});
		});

		// console.log(fl_obj);
		if(fl_obj[fl_obj.length - 1].bal_amo === 0){
			const obj = {fl_obj, res_flag : true};
			return obj;
		} else {
			const obj = {fl_obj, res_flag : false};
			return obj;
		}
		
	}

	let result_flag = false;
	_obj.child.forEach((element, inx) => {

		const res = ldrwithchildHandler(element);
		if(res.res_flag){
			final_all_obj.push(...res.fl_obj);
		} else {
			final_all_obj.push(...res.fl_obj);
			final_flag : false;
		}

		//-------------------------------------------------

		const tr_amo = Number(element.tr_amount);
		const tr_type = element.tr_type;
		const bal_amo = Number(element.tr_amount);
		const bal_type = element.tr_type;
		final_all_obj.push({tr_amo : 0, tr_type : "", bal_amo, bal_type});

		const _rtramo = Number(element.tr_amount);
		const _rtrtype = element.tr_type;
		if(_rtrtype === final_all_obj[inx].bal_type){
			rBal_amo = Math.abs(final_all_obj[inx].bal_amo - _rtramo);
			rBal_type = (rBal_amo === 0) ? "" : _rtrtype;
		} else if(_rtrtype === "DR" && final_all_obj[inx].bal_type === "DR"){
			rBal_amo = Math.abs(final_all_obj[inx].bal_amo - _rtramo);
			rBal_type = _rtrtype;
		} else if(_rtrtype === "CR" && final_all_obj[inx].bal_type === "DR"){
			rBal_amo = final_all_obj[inx].bal_amo + _rtramo;
			rBal_type = (final_all_obj[inx].bal_amo > _rtramo) ? final_all_obj[inx].bal_type : _rtrtype;	
		} else if(_rtrtype === "DR" && final_all_obj[inx].bal_type === "CR"){
			rBal_amo = final_all_obj[inx].bal_amo + _rtramo;
			rBal_type = (final_all_obj[inx].bal_amo > _rtramo) ? final_all_obj[inx].bal_type : _rtrtype;	
		} 
		final_all_obj.push({tr_amo : _rtramo, tr_type : _rtrtype, bal_amo : rBal_amo, bal_type : rBal_type});
			
		//-------------------------------------------------

	});
	const r1_obj = {final_all_obj, final_obj,	final_flag}
	return r1_obj;
}

const res = objPositionHandler(vchr1);
console.table(res);
console.table(res.final_obj);
console.table(res.final_all_obj);

</script>
</body>
</html>
